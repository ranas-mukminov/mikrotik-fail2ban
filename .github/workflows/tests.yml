name: Tests

on:
  push:
    branches: [ main, master, feature/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt
    
    - name: Run filter tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Check RouterOS scripts syntax
      run: |
        echo "Checking RouterOS script files..."
        find . -name "*.rsc" -type f | while read file; do
          echo "Checking: $file"
          # Basic checks: no merge conflict markers, valid UTF-8
          if grep -q "<<<<<<< HEAD\|=======\|>>>>>>> " "$file"; then
            echo "ERROR: Merge conflict markers found in $file"
            exit 1
          fi
          # Check if file is valid UTF-8
          if ! iconv -f UTF-8 -t UTF-8 "$file" > /dev/null 2>&1; then
            echo "ERROR: $file is not valid UTF-8"
            exit 1
          fi
        done
        echo "All RouterOS scripts passed basic checks"
  
  docker-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -f docker/Dockerfile -t mikrotik-fail2ban:test .
    
    - name: Test Docker image
      run: |
        set -euo pipefail
        
        # Set up cleanup trap
        trap 'docker logs test-container 2>&1 || true; docker rm -f test-container 2>&1 || true' EXIT
        
        echo "Starting container in detached mode..."
        docker run -d --name test-container mikrotik-fail2ban:test
        
        # Wait up to 30 seconds for the container to become healthy/running
        echo "Waiting for container to start..."
        for i in {1..30}; do
          if docker ps --filter "name=test-container" --filter "status=running" --format '{{.ID}}' | grep -q .; then
            echo "Container is running!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "ERROR: Container failed to start within 30 seconds"
            echo "Container status:"
            docker ps -a --filter "name=test-container"
            echo ""
            echo "Container logs:"
            docker logs test-container 2>&1 || true
            exit 1
          fi
          sleep 1
        done
        
        # Give fail2ban a moment to fully initialize
        sleep 3
        
        # Check if fail2ban is running
        echo "Testing fail2ban-client ping..."
        if ! docker exec test-container fail2ban-client ping; then
          echo "ERROR: fail2ban-client ping failed"
          echo "Container logs:"
          docker logs test-container 2>&1 || true
          exit 1
        fi
        
        # Check version
        echo "Testing fail2ban-client version..."
        docker exec test-container fail2ban-client version
        
        echo ""
        echo "âœ“ Docker image test passed"
