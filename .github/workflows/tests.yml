name: Tests

on:
  push:
    branches: [ main, master, feature/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r tests/requirements.txt
    
    - name: Run filter tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Check RouterOS scripts syntax
      run: |
        echo "Checking RouterOS script files..."
        find . -name "*.rsc" -type f | while read file; do
          echo "Checking: $file"
          # Basic checks: no merge conflict markers, valid UTF-8
          if grep -q "<<<<<<< HEAD\|=======\|>>>>>>> " "$file"; then
            echo "ERROR: Merge conflict markers found in $file"
            exit 1
          fi
          # Check if file is valid UTF-8
          if ! iconv -f UTF-8 -t UTF-8 "$file" > /dev/null 2>&1; then
            echo "ERROR: $file is not valid UTF-8"
            exit 1
          fi
        done
        echo "All RouterOS scripts passed basic checks"
  
  docker-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -f docker/Dockerfile -t mikrotik-fail2ban:test .
    
    - name: Test Docker image
      run: |
        # Start container in detached mode
        docker run -d --name test-container mikrotik-fail2ban:test
        
        # Wait a few seconds for startup
        sleep 5
        
        # Check if fail2ban is running
        docker exec test-container fail2ban-client ping || exit 1
        
        # Check version
        docker exec test-container fail2ban-client version
        
        # Clean up
        docker stop test-container
        docker rm test-container
        
        echo "Docker image test passed"
